<!DOCTYPE html>  <html> <head>   <title>displayed-articles.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="rocco.css" /> </head> <body> <div id="navbar">     <h3>Google News - Chrome App<em></em></h3>   </div>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">           <a class="source" href="index.html">Index</a>                                           <a class="source" href="google.html">                 google.js               </a>                                           <a class="source" href="foreground-setup.html">                 foreground-setup.js               </a>                                           <a class="source" href="background-setup.html">                 background-setup.js               </a>                                           <a class="source" href="setup.html">                 setup.js               </a>                                           <a class="source" href="background.html">                 background.js               </a>                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="article.html">                 article.js               </a>                                           <a class="source" href="displayed-articles.html">                 displayed-articles.js               </a>                                           <a class="source" href="search.html">                 search.js               </a>                                           <a class="source" href="setting.html">                 setting.js               </a>                                           <a class="source" href="article-view.html">                 article-view.js               </a>                                           <a class="source" href="category-view.html">                 category-view.js               </a>                                           <a class="source" href="fullscreen-view.html">                 fullscreen-view.js               </a>                                           <a class="source" href="intent-view.html">                 intent-view.js               </a>                                           <a class="source" href="notifications-view.html">                 notifications-view.js               </a>                                           <a class="source" href="search-results-view.html">                 search-results-view.js               </a>                                           <a class="source" href="search-view.html">                 search-view.js               </a>                                           <a class="source" href="settings-view.html">                 settings-view.js               </a>                                           <a class="source" href="window-view.html">                 window-view.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               displayed-articles.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global App */</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Authors</h3>

<p>Jamie Dyer <a href="http://kernowsoul.com">http://kernowsoul.com</a></p>

<h3>Last changed</h3>

<p>2012-06-23</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>App.DisplayedArticles</h2>

<p>The App.DisplayedArticles is used to keep track of articles that are to be
displayed. It handles the loading of new articles from the data store and firing
events that views can listen for.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">DisplayedArticles</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Set the indexedDb database to use</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">database</span><span class="o">:</span>   <span class="nx">App</span><span class="p">.</span><span class="nx">articlesDatabase</span><span class="p">,</span>
  <span class="nx">storeName</span><span class="o">:</span>  <span class="s2">&quot;articles&quot;</span><span class="p">,</span>
  <span class="nx">model</span><span class="o">:</span>      <span class="nx">App</span><span class="p">.</span><span class="nx">Article</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>initialize</h3>

<p>Setup listeners for various events raised by the articles collection</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Set loading to false, use to track if the class is currently loading data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;allRemoved&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">allRemoved</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">articleAdded</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;articlesFromCategoryRemoved&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeWithCategory</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;filterCategoryChanged&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterCategoryChanged</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>comparator</h3>

<p>sort articles by the updatedTime field so that newest articles are first</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">article</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="nx">article</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;updatedTime&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>articleAdded</h3>

<p>handles new articles that have been added and decides if they should
be displayed. Articles that are newer than the oldest article currently displayed
are added. Older articles are also added if the number of articles currently
displayed is less than the value of App.perPage</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">articleAdded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">article</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">oldestTime</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Work out the timestamp of the oldest article displayed or set to 0</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
      <span class="nx">oldestTime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;updatedTime&#39;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">oldestTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Add the article to the collection if it's newer than the oldest article
or if there are less articles displayed than should be on a single page</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">App</span><span class="p">.</span><span class="nx">perPage</span> <span class="o">||</span> <span class="nx">oldestTime</span> <span class="o">&lt;</span> <span class="nx">article</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;updatedTime&#39;</span><span class="p">)){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">article</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;articlesAdded&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>removeWithCategory(category)</h3>

<p>Removes all articles with the specified category then triggers the <code>articlesRemoved</code> event</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">removeWithCategory</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">category</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="s1">&#39;categoryEnglish&#39;</span><span class="o">:</span> <span class="nx">category</span> <span class="p">}));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;articlesRemoved&quot;</span><span class="p">,</span> <span class="nx">category</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>allRemoved</h3>

<p>Removes all articles form the collection</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">allRemoved</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>filterCategoryChanged(category)</h2>

<p>When the filter category is changed we need to remove all articles from the collection
and load in new articles</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">filterCategoryChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">category</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>load</h3>

<p>Load articles form indexedDb, articles will be loaded with a limit the same as the
number set in App.perPage to support pagination.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">articlesLength</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If there is a filter category then only include the category in the length comparisons</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">filterCategory</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">getFilterCategory</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">filterCategory</span> <span class="o">!=</span> <span class="s1">&#39;allStories&#39;</span><span class="p">){</span>
      <span class="nx">length</span>          <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="s1">&#39;categoryEnglish&#39;</span><span class="o">:</span> <span class="nx">filterCategory</span> <span class="p">}).</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">articlesLength</span>  <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="s1">&#39;categoryEnglish&#39;</span><span class="o">:</span> <span class="nx">filterCategory</span> <span class="p">}).</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">articlesLength</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Check if there are articles to load, or if articles are already being loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">((</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">articlesLength</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">loading</span><span class="p">)</span> <span class="o">||</span> <span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Set loading to be true so we don't load twice at the same time</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Set the to time to 0 so we can load articles up to the beginning of time</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">to</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Set the from time the date of the last article we have and minus 1 off the value
as ranges in indexedDb load results between, but not including, the range limits</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;updatedTime&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If there are no articles in this collection set the time limit to the current time</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">from</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">conditions</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;updatedTime&#39;</span><span class="o">:</span> <span class="p">[</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">]</span> <span class="p">};</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">filterCategory</span> <span class="o">!=</span> <span class="s1">&#39;allStories&#39;</span><span class="p">){</span>
        <span class="nx">conditions</span><span class="p">.</span><span class="nx">categoryEnglish</span> <span class="o">=</span> <span class="nx">filterCategory</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Fetch the articles, we pass add: true so that the articles are added to the current
collection and do not replacing  it. The success callback sets the loading variable
to false so load() can be called again and also triggers the articlesAdded event so
views know all the articles have been loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
        <span class="nx">add</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">limit</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">perPage</span><span class="p">,</span>
        <span class="nx">conditions</span><span class="o">:</span> <span class="nx">conditions</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;articlesAdded&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 