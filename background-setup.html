<!DOCTYPE html>  <html> <head>   <title>background-setup.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="rocco.css" /> </head> <body> <div id="navbar">     <h3>Google News - Chrome App<em></em></h3>   </div>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">           <a class="source" href="index.html">Index</a>                                           <a class="source" href="google.html">                 google.js               </a>                                           <a class="source" href="ui.html">                 ui.js               </a>                                           <a class="source" href="background-setup.html">                 background-setup.js               </a>                                           <a class="source" href="setup.html">                 setup.js               </a>                                           <a class="source" href="background.html">                 background.js               </a>                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="article.html">                 article.js               </a>                                           <a class="source" href="displayed-articles.html">                 displayed-articles.js               </a>                                           <a class="source" href="search.html">                 search.js               </a>                                           <a class="source" href="setting.html">                 setting.js               </a>                                           <a class="source" href="article-view.html">                 article-view.js               </a>                                           <a class="source" href="category-view.html">                 category-view.js               </a>                                           <a class="source" href="fullscreen-view.html">                 fullscreen-view.js               </a>                                           <a class="source" href="intent-view.html">                 intent-view.js               </a>                                           <a class="source" href="notifications-view.html">                 notifications-view.js               </a>                                           <a class="source" href="search-results-view.html">                 search-results-view.js               </a>                                           <a class="source" href="search-view.html">                 search-view.js               </a>                                           <a class="source" href="settings-view.html">                 settings-view.js               </a>                                           <a class="source" href="window-view.html">                 window-view.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               background-setup.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global App: false, Filer: false, webkitNotifications: false */</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Authors</h3>

<p>Jamie Dyer <a href="http://kernowsoul.com">http://kernowsoul.com</a></p>

<h3>Last changed</h3>

<p>2012-06-23</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Overview</h2>

<p>This file is loaded when the background process runs and is used to setup the application.
The background process handles loading articles when the app is not running and notifying the
user when new articles have been downloaded.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Initialize the settings model</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">App</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Settings</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Fetch settings from the Google sync storage</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">App</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>If no categories have been previously stored load the defaults from the json file</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">App</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">)){</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;javascripts/settings.json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Save the categories in the settings model</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">App</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="s2">&quot;categories&quot;</span> <span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">defaultCategories</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Now we have the settings loaded we can initialize the articles</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">App</span><span class="p">.</span><span class="nx">initializeArticles</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Settings have been fetched so we can initialize the articles</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">App</span><span class="p">.</span><span class="nx">initializeArticles</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>App.initializeMessageHandlers</h3>

<p>This function sets up the handlers for inter-process communications. When the app is launched
it sends a message to the background process so it can stop processing the news feeds. The main
app handles news feed processing when it's running</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">initializeMessageHandlers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Temporary message listening code</h3>

<p>currently there is no event for when the app window is closed so we get the main app to send a message to
the background process every 60 seconds telling it to stay paused. There should be an onSuspend event at
some point which can be used, we can then tell the background process to resume when the main app window
is closed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">onMessage</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">sendResponse</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
        <span class="k">case</span> <span class="s1">&#39;pause&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Stop processing new articles, but set to automatically resume in 70 seconds</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">App</span><span class="p">.</span><span class="nx">pauseProcessing</span><span class="p">(</span><span class="mi">90000</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;appOpened&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>When the main app is opened clear any unread notification counts as we assume everything is now read</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">App</span><span class="p">.</span><span class="nx">notificationsView</span><span class="p">.</span><span class="nx">clearCounts</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>App.pauseProcessing</h3>

<p>Accepts the <code>interval</code> parameter, if passed it will call <code>App.resumeProcessing()</code> after the specified amount
of time.
This function pauses the processing of the news feeds by setting the <code>App.canBackgroundProcess</code> variable to
<code>false</code>. Other classes look at this variable to know if they should run their code.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">pauseProcessing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">interval</span><span class="p">){</span>
  <span class="nx">App</span><span class="p">.</span><span class="nx">canBackgroundProcess</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">pauseProcessingIntervalId</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">interval</span><span class="p">){</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">pauseProcessingIntervalId</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">App</span><span class="p">.</span><span class="nx">resumeProcessing</span><span class="p">();</span>
    <span class="p">},</span> <span class="nx">interval</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>App.resumeProcessing</h3>

<p>Simply sets <code>App.canBackgroundProcess</code> to <code>true</code> so that other classes will know they are allowed to run their code</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">resumeProcessing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">App</span><span class="p">.</span><span class="nx">canBackgroundProcess</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Call <code>App.resumeProcessing()</code> immediately so processes know they can run</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">resumeProcessing</span><span class="p">();</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">initializeMessageHandlers</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>App.initializeArticles</h3>

<p>Handles all initialization to do with the articles collections and model</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">initializeArticles</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Initialize filer, this is a wrapper library for the HTML5 Filesystem API</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">App</span><span class="p">.</span><span class="nx">filer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Filer</span><span class="p">();</span>
  <span class="nx">App</span><span class="p">.</span><span class="nx">filer</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span><span class="nx">persistent</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">filer</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">10485760</span><span class="p">;</span> <span class="c1">// set the file size limit to 10 mb</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Filer is now initialized, the articles collection can be initialized</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Articles</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Now that the articles collection exists we can initialize notifications</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">App</span><span class="p">.</span><span class="nx">initializeNotifications</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Load up articles from storage</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Tell the articles model to start pulling data from the Google news feeds</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">startProcessing</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Log any filer errors to the console for debugging</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;error: &#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>App.initializeNotifications</h3>

<p>Handle notification initialization</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">initializeNotifications</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">App</span><span class="p">.</span><span class="nx">notificationsView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">NotificationsView</span><span class="p">({</span> <span class="nx">collection</span><span class="o">:</span> <span class="nx">App</span><span class="p">.</span><span class="nx">articles</span> <span class="p">});</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 